#!/bin/bash
# Title: spm
# Description: Downloads and installs AppImages and precompiled tar archives.  Can also upgrade and remove installed packages.
# Dependencies: GNU coreutils, tar, wget, python3.x
# Author: simonizor
# Website: http://www.simonizor.gq
# License: GPL v2.0 only

X="0.2.1"
# Set spm version
CONFDIR="$HOME/.config/spm"

if [ "$EUID" = "0" ]; then # Prevent spm from being ran as root
    echo "Do not run spm as root!"
    exit 1
fi

if [ -f ~/.config/simplepackagemanager/spm.conf ]; then
    . ~/.config/simplepackagemanager/spm.conf
elif [ -f ~/.config/spm/spm.conf ]; then
    . ~/.config/spm/spm.conf
fi

if [ ! -d "$CONFDIR" ]; then # Create dirs for configs if they don't exist
    echo "spm is being ran for the first time."
    echo "Creating config directories..."
    mkdir "$CONFDIR"
    case $? in
        1)
            echo "Failed to create $HOME/.config/spm; falling back to $HOME/.config/simplepackagemanager ..."
            CONFDIR="$HOME/.config/simplepackagemanager"
            mkdir "$CONFDIR" || { echo "Why are we still failing here? Something wrong with $HOME/.config ?"; exit 1; }
            ;;
    esac
    mkdir "$CONFDIR"/tarinstalled
    mkdir "$CONFDIR"/appimginstalled
    mkdir "$CONFDIR"/tarupgrades
    mkdir "$CONFDIR"/appimgupgrades
    mkdir "$CONFDIR"/cache
    echo "CONFDIR="\"$CONFDIR\""" > "$CONFDIR"/spm.conf
    echo "GITHUB_TOKEN="\"\""" >> "$CONFDIR"/spm.conf
    echo "Downloading AppImages-github.lst from spm github..."
    wget --quiet --show-progress "https://raw.githubusercontent.com/simoniz0r/spm/master/AppImages-github.lst" -O "$CONFDIR"/AppImages-github.lst
    echo "Downloading AppImages-direct.lst from spm github..."
    wget --quiet --show-progress "https://raw.githubusercontent.com/simoniz0r/spm/master/AppImages-direct.lst" -O "$CONFDIR"/AppImages-direct.lst
    echo "Downloading tar-pkgs.json from spm github repo..."
    wget --quiet --show-progress "https://raw.githubusercontent.com/simoniz0r/spm/master/tar-pkgs.json" -O "$CONFDIR"/tar-pkgs.json
    echo "First run operations complete!"
fi

REALPATH="$(readlink -f $0)"
RUNNING_DIR="$(dirname "$REALPATH")" # Find directory script is running from
if [ -f $RUNNING_DIR/spmfunctions.sh ]; then
    FUNCTIONS_VER="$(cat "$RUNNING_DIR"/spmfunctions.sh | sed -n 9p | cut -f2 -d'"')"
    if [ "$X" != "$FUNCTIONS_VER" ]; then
        echo "spmfunctions.sh $FUNCTIONS_VER version does not match $X; removing and updating..."
        rm "$RUNNING_DIR"/spmfunctions.sh || { echo "rm $RUNNING_DIR/spmfunctions.sh failed; trying with sudo..."; sudo rm "$RUNNING_DIR"/spmfunctions.sh; }
        echo "$RUNNING_DIR/spmfunctions.sh has been removed."
        echo "Downloading spmfunctions.sh from spm github repo..."
        wget --quiet --show-progress "https://github.com/simoniz0r/appimgman/raw/spm/spmfunctions.sh" -O "$CONFDIR"/cache/spmfunctions.sh
        chmod +x "$CONFDIR"/cache/spmfunctions.sh
        mv "$CONFDIR"/cache/spmfunctions.sh "$RUNNING_DIR"/spmfunctions.sh || { echo "mv to $RUNNING_DIR failed; trying as sudo..."; sudo mv "$CONFDIR"/cache/spmfunctions.sh "$RUNNING_DIR"/spmfunctions.sh; }
        echo "spmfunctions.sh saved to $RUNNING_DIR/spmfunctions.sh"
    fi
else
    echo "Missing required file $RUNNING_DIR/spmfunctions.sh !"
    echo "Downloading spmfunctions.sh from spm github repo..."
    wget --quiet --show-progress "https://github.com/simoniz0r/appimgman/raw/spm/spmfunctions.sh" -O "$CONFDIR"/cache/spmfunctions.sh
    chmod +x "$CONFDIR"/cache/spmfunctions.sh
    mv "$CONFDIR"/cache/spmfunctions.sh "$RUNNING_DIR"/spmfunctions.sh || { echo "mv to $RUNNING_DIR failed; trying as sudo..."; sudo mv "$CONFDIR"/cache/spmfunctions.sh "$RUNNING_DIR"/spmfunctions.sh; }
    echo "spmfunctions.sh saved to $RUNNING_DIR/spmfunctions.sh"
fi
source "$RUNNING_DIR"/spmfunctions.sh # import functions from spmfunctions.sh

spmdepchecksfunc || { echo "Could not load $RUNNING_DIR/spmfunctions.sh; exiting..."; exit 1; } # Check for deps, exit if not present

appimgfunctioncheckfunc # Check if appimgfunctions.sh exists, check version if it does, download if out of date or doesn't
source "$RUNNING_DIR"/appimgfunctions.sh # import functions from appimgfunctions.sh
appimgfunctionsexistsfunc  || { echo "Could not load $RUNNING_DIR/appimgfunctions.sh; exiting..."; exit 1; }

tarfunctioncheckfunc # Check if tarfunctions.sh exists, check version if it does, download if out of date or doesn't
source "$RUNNING_DIR"/tarfunctions.sh # import functions from tarfunctions.sh
tarfunctionsexistfunc || { echo "Could not load $RUNNING_DIR/tarfunctions.sh; exiting..."; exit 1; }

jsonparsecheck

spmlockfunc # Create "$CONFDIR"/cache/spm.lock file and prevent multiple instances by checking if it exists before running

if [ -z "$GITHUB_TOKEN" ]; then
    wget -S --spider "https://api.github.com/rate_limit" -o "$CONFDIR"/cache/rate.limit
    echo "Github API rate limit: $(grep -m 1 '.*X-RateLimit-Remaining:*.' "$CONFDIR"/cache/rate.limit | cut -f4 -d" ")/60 until $(date -d@$(grep -m 1 '.*X-RateLimit-Reset:*.' "$CONFDIR"/cache/rate.limit | cut -f4 -d" ") +"%T, %F")."
else
    wget -S --spider --quiet --auth-no-challenge --header="Authorization: token "$GITHUB_TOKEN"" "https://api.github.com/rate_limit" -o "$CONFDIR"/cache/rate.limit
    echo "Github API rate limit : $(grep -m 1 '.*X-RateLimit-Remaining:*.' "$CONFDIR"/cache/rate.limit | cut -f4 -d" ")/5000 until $(date -d@$(grep -m 1 '.*X-RateLimit-Reset:*.' "$CONFDIR"/cache/rate.limit | cut -f4 -d" ") +"%T, %F")."
fi
if [ "$(grep -m 1 '.*X-RateLimit-Remaining:*.' "$CONFDIR"/cache/rate.limit | cut -f4 -d" ")" = "0" ]; then
    echo "Github API rate limit reached! Try again at $(date -d@$(grep -m 1 '.*X-RateLimit-Reset:*.' "$CONFDIR"/cache/rate.limit | cut -f4 -d" "))."
    echo "If you haven't already, you can add your token to $CONFDIR/spm.conf"
    echo "to avoid hitting the rate limit."
    rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
    exit 1
fi
echo

case $1 in
    appimg-install|-ai) # Check if package is already installed either by spm or otherwise then install package
        if [ -z "$2" ]; then
            echo "Package input required; exiting..."
            rm -rf "$CONFDIR"/cache/*
            exit 1
        fi
        INSTIMG="$2"
        appimginstallstartfunc
        appimgdlfunc "$INSTIMG"
        appimginstallfunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    tarinstall|-ti) # Check if package is already installed either by spm or otherwise then install package
        if [ -z "$2" ]; then
            echo "Package input required; exiting..."
            rm -rf "$CONFDIR"/cache/*
            exit 1
        fi
        TARPKG="$2"
        tarinstallstartfunc
        tardlfunc "$TARPKG"
        tarcheckfunc
        tarinstallfunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    update|-upd) # Update package lists and check for package upgrades
        spmvercheckfunc
        updatestartfunc "$2" # Send input to relevant update function or run both if no input
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    appimg-update-force|-auf) # Force AppImage to be marked for upgrade
        INSTIMG="$2"
        appimgupdateforcefunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    tar-update-force|-tuf) # Force tar package to be marked for upgrade
        TARPKG="$2"
        tarupdateforcefunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    upgrade|-upg) # upgrade packages to latest version if marked for upgrade
        upgradestartfunc "$2" # Check which (if any) package types have upgrades and run relevant functions
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    appimg-remove|-ar) # rm AppImage from /usr/local/bin and rm install info in "$CONFDIR"/installed
        if [ -z "$2" ]; then
            echo "AppImage input required; exiting..."
            rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
            exit 1
        fi
        REMIMG="$2"
        if [ -f "$CONFDIR"/appimginstalled/"$REMIMG" ]; then
            echo "Current installed $REMIMG information:"
            cat "$CONFDIR"/appimginstalled/"$REMIMG"
        else
            echo "AppImage not found!"
            rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
            exit 1
        fi
        appimgremovefunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    tar-remove|-tr) # Remove: remove pkg while leaving pkg's config files
        if [ -z "$2" ]; then
            echo "Package input required; exiting..."
            rm -rf "$CONFDIR"/cache/*
            exit 1
        fi
        REMPKG="$2"
        if [ -f "$CONFDIR"/tarinstalled/"$REMPKG" ]; then
            echo "Current installed $REMPKG information:"
            cat "$CONFDIR"/tarinstalled/"$REMPKG"
        else
            echo "Package not found!"
            rm -rf "$CONFDIR"/cache/*
            exit 1
        fi
        tarappcheckfunc "$REMPKG"
        tarremovefunc
        rm -rf "$CONFDIR"/cache/*
        exit 0
        ;;
    tar-remove-purge|-trp) # Remove Purge: remove pkg and also remove pkg's config files
        if [ -z "$2" ]; then
            echo "Package input required; exiting..."
            rm -rf "$CONFDIR"/cache/*
            exit 1
        fi
        PURGEPKG="$2"
        echo "Current installed $PURGEPKG information:"
        if [ -f "$CONFDIR"/tarinstalled/"$PURGEPKG" ]; then
            cat "$CONFDIR"/tarinstalled/"$PURGEPKG"
        else
            echo "Package not found!"
            rm -rf "$CONFDIR"/cache/*
            exit 1
        fi
        tarappcheckfunc "$PURGEPKG"
        tarremovepurgefunc
        rm -rf "$CONFDIR"/cache/*
        exit 0
        ;;
    list|-l) # List installed packages or info about specified package
        LISTIMG="$2"
        TARPKG="$2"
        liststartfunc # Send package input to relevant list function or run both if no input
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    list-installed|-li) # List information about installed packages
        echo "AppImages:"
        appimglistinstalledfunc
        echo
        echo "tar packages:"
        tarlistinstalledfunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    man)
        man $RUNNING_DIR/spm.1
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
    *) # Any unknown arguments go to help func
        helpfunc
        rm -rf "$CONFDIR"/cache/* # Remove any files in cache before exiting
        exit 0
        ;;
esac
